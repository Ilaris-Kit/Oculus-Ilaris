  <!doctype html>
  <html lang ="en">
  <head>
    <meta charset ="utf-8">
    <meta name="viewport" content ="width =device-width, initial-scale =1, shrink-to-fit =no">
    <meta name="description" content ="">
    <meta name="author" content ="">

    <title>Oculus Ilaris</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,800" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Raleway:400,400i,700" rel="stylesheet" crossorigin="anonymous">

    <script src="../js/download.js" defer="defer"></script>
    <script src="../js/local.js" defer="defer"></script>
    <script src="../js/ilaris.js" defer="defer"></script>
    <script src="../js/character.js" defer="defer"></script>
    <script src="../js/ui.js" defer="defer"></script>
    <script src="../js/vorteile.js" defer="defer"></script>

    <link rel="stylesheet" href="../css/common.css">

    <style>

    .usethis {
      font-weight: bolder;
    }

    .badInput {
      color: magenta;
    }

    #fertigkeitSelectorForm > div.form-group {
      width: 100%;
    }
    #fertigkeitSelectorForm > div.form-group > select {
      resize:vertical;
    }




    #fertigkeitSelectorForm > div.form-group > div.input-group > select,
    #fertigkeitSelectorForm > div.form-group > select,
    #fertigkeitSelectorForm > div.form-group > div.input-group >span.input-group-addon,
    #fertigkeitSelectorForm > div.form-group > div.input-group > input {
      font-family: "Open Sans Condensed";
      font-size: 140%;
      height: 3rem;

    }

    .erfolg {
      color: darkgreen;
    }

    .fehlschlag {
      color: darkred;
    }



    </style>

  </head>
  <body>

    <div id="navWrapper">

    </div>

    <div class="container">
      <div class="row">
        <div class="col-12">
          <form id="fertigkeitSelectorForm" class="d-flex" style="justify-content: space-between; flex-wrap: wrap; align-items: stretch;">


            <div class="form-group" id="fertigkeitSelectorKategorienDiv">

              <div class="input-group">
                <span class="input-group-addon clickable" style="flex-grow: 1; justify-content: center;"><input id="fertigkeitSelectorKategorienOptionK" type="checkbox" style="margin-right: .5rem;" checked>K</span>
                <span style="flex-grow: 1; justify-content: center" class="input-group-addon clickable"><input id="fertigkeitSelectorKategorienOptionP" type="checkbox" style="margin-right: 10px" checked>P</span>
                <span style="flex-grow: 1; justify-content: center" class="input-group-addon clickable"><input id="fertigkeitSelectorKategorienOptionU" type="checkbox" style="margin-right: 10px" checked>U</span>
                <span id="fertigkeitSelectorDisplayFertigkeitenGroupedSpan" style="flex-grow: 1; justify-content: center;" class="input-group-addon clickable"><input id="fertigkeitSelectorDisplayFertigkeitenGrouped" type="checkbox" style="margin-right: 10px" checked>Gruppieren</span>

              </div>
            </div>
            <div class="form-group" id="fertigkeitSelectorFertigkeitenDiv">
              <select class="form-control custom-select" id="fertigkeitSelectorFertigkeiten" style="flex-grow: 100;">
              </select>
            </div>

            <div class="form-group" id="fertigkeitSelectorTalenteDiv">
              <div class="input-group">
                <span class="input-group-addon clickable" style="justify-content: center;"><input id="fertigkeitSelectorTalenteJa" type="checkbox" checked><span id="fertigkeitSelectorTalenteJaSpan" style="margin-left: .5rem;" >Talent auswählen</span></span>
                <select class="form-control custom-select" id="fertigkeitSelectorTalente">
                </select>
              </div>
            </div>
            <div class="form-group" id="fertigkeitSelectorModusDiv">
              <div class="input-group">
                <span class="input-group-addon clickable" style="justify-content: center;">
                  <input id="fertigkeitSelectorModusSG" type="radio" name="fertigkeitSelectorModus" checked>
                  <span id="fertigkeitSelectorModusSGSpan" style="margin-left: .5rem;" >SG</span>
                </span>
                <span class="input-group-addon clickable" style="justify-content: center;">
                  <input id="fertigkeitSelectorModusVP" type="radio" name="fertigkeitSelectorModus">
                  <span id="fertigkeitSelectorModusVPSpan" style="margin-left: .5rem;" >NSC</span>
                </span>
                <input class="form-control usethis" id="fertigkeitSelectorModusText" value ="12" type="number">
                <span class="input-group-btn">
                  <button class="btn btn-secondary" type="button" id="fertigkeitSelectorDec">▼</button>
                  <button class="btn btn-secondary" type="button" id="fertigkeitSelectorInc">▲</button>
                </span>
                <span class="input-group-btn">
                  <button class="btn btn-primary" type="button" id="fertigkeitSelectorWuerfeln">Würfeln</button>
                </span>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <ul class="list-group" id="probenListe">
          </ul>
        </div>

      </div>

    </div>






    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src ="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin ="anonymous"></script>
    <script src ="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" crossorigin ="anonymous"></script>
    <script src ="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" crossorigin ="anonymous"></script>
    <script>
    $("#navWrapper").load("nav.html", function() {$("#phexLink").addClass("active"); $(".navbar-brand").text("Phex");});
    $(document).ready(function () {


      initializeIlaris(function() {
        var fertigkeiten = $("#fertigkeitSelectorFertigkeiten");
        var talente = $("#fertigkeitSelectorTalente");
        $("#fertigkeitSelectorTalenteJa").on("change", function(e) {
          var state = $("#fertigkeitSelectorTalenteJa").prop("checked");
          talente.prop("disabled", !state);
          if (state) {
            talente.addClass("usethis");
            fertigkeiten.removeClass("usethis");
          } else {
            talente.removeClass("usethis");
            fertigkeiten.addClass("usethis");
          }
          updateProbenListe();
        });
        $("input[id^='fertigkeitSelectorModus']").on("change", updateProbenListe);
        $("#fertigkeitSelectorModusText").on("input", function(e) {
          if ($("#fertigkeitSelectorModusText")[0].checkValidity()) {
            $("#fertigkeitSelectorModusText").removeClass("is-invalid");
            $("#fertigkeitSelectorInc").prop("disabled", false);
            $("#fertigkeitSelectorDec").prop("disabled", false);
            updateProbenListe();
          } else {
            $("#fertigkeitSelectorModusText").addClass("is-invalid");
            $("#fertigkeitSelectorInc").prop("disabled", true);
            $("#fertigkeitSelectorDec").prop("disabled", true);
          }
        });

        PhexCharacters = getCharacterListFromLocalStorage();

        updateFertigkeitSelector();
        updateProbenListe();

        var fertigkeitenWrapper = $("#fertigkeitSelectorFertigkeitenDiv");


        fertigkeiten.on("change", updateFertigkeitSelector);
        talente.on("change", updateFertigkeitSelector);
        $("#fertigkeitSelectorKategorienOptionK, #fertigkeitSelectorKategorienOptionP, #fertigkeitSelectorKategorienOptionU").on("change", updateFertigkeitSelector);
        $("#fertigkeitSelectorDisplayFertigkeitenGrouped").on("change", rewriteEntries);

        $("#fertigkeitSelectorDec").on("click", function(e) {
          $("#fertigkeitSelectorModusText").val(parseInt($("#fertigkeitSelectorModusText").val()) - 1);
          $("#fertigkeitSelectorModusText").change();
        });
        $("#fertigkeitSelectorInc").on("click", function(e) {
          $("#fertigkeitSelectorModusText").val(parseInt($("#fertigkeitSelectorModusText").val()) + 1);
          $("#fertigkeitSelectorModusText").change();
        });


        $(".clickable").on("click", function(e) {
          if ($(e.target).is("input[type='checkbox']") || $(e.target).is("input[type='radio']")) return;
          $.each($(this).children("input[type=checkbox], input[type='radio']"), function(i, cb) {
            if ($(cb).prop("disabled")) return;
            $(cb).prop("checked", !$(cb).prop("checked") || $(cb).is("input[type='radio']"));
            $(cb).change();
          });
          e.preventDefault();

        }
      );

      var wide = !($(window).width() >= 500);

      $(window).resize(function(e) {

        if ($(window).width() >= 500 && wide == false) {
          wide = true;
          var grp = $("#fertigkeitSelectorDisplayFertigkeitenGroupedSpan");
          fertigkeiten.insertBefore(grp);
          fertigkeitenWrapper.addClass("d-none");
          $("#fertigkeitSelectorTalenteJaSpan").removeClass("d-none");
          return;
        }
        if ($(window).width() < 500 && wide == true) {
          wide = false;
          fertigkeitenWrapper.removeClass("d-none");
          fertigkeitenWrapper.append(fertigkeiten);
          $("#fertigkeitSelectorTalenteJaSpan").addClass("d-none");
        }

      });

      $("#fertigkeitSelectorForm").on("submit", function(e) {
        e.preventDefault();
        $.each(PhexCharacters, function(c, charname) {
          $("#probenListeWuerfeln_" + charname.hashCode()).trigger("click");
        });
      });


      $("#fertigkeitSelectorWuerfeln").on("click", function (e) {
        $("#fertigkeitSelectorForm").trigger("submit");
      });

      $(window).trigger("resize");



  });
  });

  fertigkeitSelectorState = {
    kategorien: new Set(),
    fertigkeiten: new Set(),
    talente: new Set(),
    character: null
  }

  function rewriteEntries() {
    var group = $("#fertigkeitSelectorDisplayFertigkeitenGrouped").prop("checked");
    var fertigkeiten = $("#fertigkeitSelectorFertigkeiten");
    $.each(
      fertigkeiten.children("option"),
      function (o, option) {
        var text = $(option).text();
        var kategorie = $(option).attr("id").split("_")[1];

        var splitted = text.split(kategorie + " ");

        if ((splitted[0] === "")) {
          splitted.splice(0,1);
          text = splitted.join("");
        }

        var prefix = "";

        if (group) {
          prefix = kategorie + " ";
        }

        $(option).text(prefix + text);
      }
    );
    sortSelect(fertigkeiten);
  }

  function updateFertigkeitSelectorState() {
    var fertigkeiten = $("#fertigkeitSelectorFertigkeiten");
    var talente = $("#fertigkeitSelectorTalente");

    var diff = {
      added: {
        kategorien: new Set(),
        fertigkeiten: new Set(),
        talente: new Set()
      },
      removed: {
        kategorien: new Set(),
        fertigkeiten: new Set(),
        talente: new Set()
      }
    };

    var selectedChar = null;
    var selectedForChar = false;
    var selectedForCharKategorie = null;

    $.each(
      ["K", "P", "U"],
      function(k, kategorie) {
        var kategorieSelected = $("#fertigkeitSelectorKategorienOption" + kategorie).prop("checked");
        $.each(PhexCharacters, function(c, cc) {
          if (selectedForChar) return;
          var forThisChar = selectedPseudoForKategorieAndCharacter(kategorie, cc);
          selectedForChar = forThisChar;
          if (forThisChar) {
            selectedChar = cc;
            selectedForCharKategorie = kategorie;
          }
        });

        if (fertigkeitSelectorState.kategorien.has(kategorie)) {
          if (kategorieSelected) {
            $.each(
              Ilaris[kategorie + "Fertigkeiten"],
              function(f, ff) {
                var fertigkeitSelected = (selectedForChar && selectedForCharKategorie === kategorie) || selectedPseudoForKategorie(kategorie) || $("#fertigkeitSelectorFertigkeitenOption_" + kategorie + "_" + f.hashCode()).prop("selected");
                if (fertigkeitSelectorState.fertigkeiten.has(f)) {
                  if (fertigkeitSelected) {

              } else {
                diff.removed.fertigkeiten.add(f);
                fertigkeitSelectorState.fertigkeiten.delete(f);
          }
        } else {
          if (fertigkeitSelected) {
            diff.added.fertigkeiten.add(f);
            fertigkeitSelectorState.fertigkeiten.add(f);
      } else {

      }
    }
  }
  );
  } else {
    diff.removed.kategorien.add(kategorie);
    fertigkeitSelectorState.kategorien.delete(kategorie);
    $.each(
      Ilaris[kategorie + "Fertigkeiten"],
      function(f, ff) {
        diff.removed.fertigkeiten.add(f);
        fertigkeitSelectorState.fertigkeiten.delete(f);
      }
    );
  }
  } else {
    if (kategorieSelected) {
      diff.added.kategorien.add(kategorie);
      fertigkeitSelectorState.kategorien.add(kategorie);
      $.each(
        Ilaris[kategorie + "Fertigkeiten"],
        function(f, ff) {
          var fertigkeitSelected = (selectedForChar && selectedForCharKategorie === kategorie) || selectedPseudoForKategorie(kategorie) || $("#fertigkeitSelectorFertigkeitenOption_" + kategorie + "_" + f.hashCode()).prop("selected");
          if (fertigkeitSelected) {
            diff.added.fertigkeiten.add(f);
            fertigkeitSelectorState.fertigkeiten.add(f);
            $.each(
              Ilaris[kategorie + "Fertigkeiten"],
              function(f, ff) {
                diff.removed.fertigkeiten.add(f);
                fertigkeitSelectorState.fertigkeiten.delete(f);
              }
            );

          }
        }
      );

    } else {
    }

  }

  });

  for (var t of fertigkeitSelectorState.talente.keys()) {
    diff.removed.talente.add(t);
  }

  fertigkeitSelectorState.talente.clear();

  for (var f of fertigkeitSelectorState.fertigkeiten.keys()) {

    var obj = Ilaris;
    if (selectedForChar) {
      obj = PhexCharacterObjects(selectedChar);
    }

    var kategorie = null;
    $.each(["K", "P", "U"], function(k, kat) {
      if (Ilaris[kat + "Fertigkeiten"].hasOwnProperty(f)) kategorie = kat;
    });

    $.each(Ilaris[kategorie + "Fertigkeiten"][f]["talente"], function(t, tt) {
      if (!selectedForChar || obj[kategorie + "Talente"][tt].selected) {
        fertigkeitSelectorState.talente.add(kategorie + "_" + f + "_" + tt);
        if (diff.removed.talente.has(kategorie + "_" + f + "_" + tt)) {
          diff.removed.talente.delete(kategorie + "_" + f + "_" + tt);
        } else {
          diff.added.talente.add(kategorie + "_" + f + "_" + tt);
        }
      }
    });
  }



  return diff;



  }

  var PhexCharactersMap = new Map();

  function PhexCharacterObjects(char) {
    if (!PhexCharactersMap.has(char)) {
      PhexCharactersMap.set(char, getCharacterFromLocalStorage(char));
    }

    return PhexCharactersMap.get(char);
  }

  var probenListeInitialized = false;
  var probenListeEntries = new Map();

  var probabilities = [0.73, 2.08, 3.28, 4.32, 5.22, 5.97, 6.58, 7.03, 7.32, 7.47, 7.47, 7.32, 7.03, 6.58, 5.97, 5.22, 4.32, 3.28, 2.08, 0.73];

  function updateProbenListe() {
    var pl = $("#probenListe");
    if (!probenListeInitialized) {
      $.each(PhexCharacters, function(c, char) {
        var forC = $("<li class=\"list-group-item d-flex justify-content-between align-items-center flex-wrap\" id=\"probenListeLi_" + char.hashCode() + "\"></li>");
        var forCName = $("<h4 class=\"w-100 d-flex justify-content-end align-items-center\"><span style=\"flex-grow: 1;\">" + char + "</span></h4>");
      //  var forCSelected = $("<span class=\"badge badge-pill\" id=\"probenListeLiSelected_" + char.hashCode() + "\"></span>")
        var forCPW = $("<span class=\"badge badge-primary badge-pill\" id=\"probenListeLiPW_" + char.hashCode() + "\"></span>")
      //  forCName.append(forCSelected);
        forCName.append(forCPW);
        var forCReq = $("<span id=\"probenListeLiReq_" + char.hashCode() + "\"></span>")
        forCReq.css("margin-right", "1rem");
        var forCProb = $("<span id=\"probenListeLiProb_" + char.hashCode() + "\"></span>")
        forCProb.css("margin-right", "1rem");
        var forCProbDyn = $("<span id=\"probenListeLiProbDyn_" + char.hashCode() + "\"></span>")

        var formGrp = $("<form class=\"w-100\"></form>");
        var formDiv = $("<div class=\"form-group w-100\"></div>");
        var inputGrp = $("<div class=\"input-group\"></div>");


        var textAddon = $("<span class=\"input-group-addon\" id=\"probenListAddon_" + char.hashCode() + "\">SG</span>");
        var inputField = $("<input class=\"form-control\" value =\"0\" type=\"number\">");
        var updown = $("<span class=\"input-group-btn\"></span>");
        var down = $("<button class=\"btn btn-secondary\" type=\"button\">▼</button>");
        var up = $("<button class=\"btn btn-secondary\" type=\"button\">▲</button>");
        updown.append(down);
        updown.append(up);



        inputField.attr("id", "probenListModifier_" + char.hashCode());
        textAddon.text("SG +");
        textAddon.css("padding-right", "4px");
        inputField.css("padding-left", "4px");
        up.css("padding-left", "2px");
        up.css("padding-right", "3px");
        down.css("padding-left", "3px");
        down.css("padding-right", "2px");



        inputField.on("input", function() {
          var fine = (inputField[0].checkValidity());
          up.prop("disabled", !fine);
          down.prop("disabled", !fine);
          if (fine) inputField.removeClass("is-invalid");
          else inputField.addClass("is-invalid");
          if (fine) {
            updateProbenListe();
    //        textAddon.text("SG " + $("#fertigkeitSelectorModusText").val() + "+");
          }

        });

        inputField.change(function() {
          inputField.trigger("input");
        });



        down.on("click", function() {
          inputField.val(parseInt(inputField.val()) - 1);
          inputField.change();
        });

        up.on("click", function() {
          inputField.val(parseInt(inputField.val()) + 1);
          inputField.change();
        });

        var button = $("<span class=\"input-group-btn\"><button class=\"btn btn-primary\" id=\"probenListeWuerfeln_" + char.hashCode() + "\">Würfeln</button></span>");


        forC.append(forCName);

        inputGrp.append(textAddon);
        inputGrp.append(inputField);
        inputGrp.append(updown);
        inputGrp.append(button);
        formDiv.append(inputGrp);
        formGrp.append(formDiv);
        forC.append(formGrp);

        forC.append(forCReq);
        forC.append(forCProb);
        forC.append(forCProbDyn);

        var resultDiv = $("<div class=\"w-100\" id=\"probenListeResult_" + char.hashCode() + "\"></div>")
        resultDiv.css("margin-top", "1rem");
        resultDiv.addClass("d-none");

        forC.append(resultDiv);
        button.on("click", function(e) {
          e.preventDefault();
          var pw = parseInt($("#probenListeLiPW_" + char.hashCode()).text().split(" ")[1]);
          var probe = new SimpleIlarisProbe(pw, 0);

          var sg = parseInt($("#fertigkeitSelectorModusText").val()) + parseInt(inputField.val());

          if ($("#fertigkeitSelectorModusVP").prop("checked")) {
            var gp = new SimpleIlarisProbe(sg, 0);
            sg = gp.result().ew;
          }

          var result = probe.result();
          var ew = result.ew;
          var gewertet = ew - pw;
          var resultString = "<strong>";
          if (ew >= sg) {
            resultString = resultString + "Erfolg!";
            if (gewertet === 20) {
              resultString = resultString + " (Triumph!)";
            }
            resultDiv.removeClass("fehlschlag");
            resultDiv.addClass("erfolg");
          } else {
            resultString = resultString +  "Fehlschlag!";
            if (gewertet === 1) {
              resultString = resultString + " (Patzer!)";
            }
            resultDiv.removeClass("erfolg");
            resultDiv.addClass("fehlschlag");
          }
          resultString = resultString + "</strong> EW " + ew + " vs " + sg + ".<br>Ergebnisse: " + result.rolls.toString() + ", gewertete "  + gewertet + ".";
          resultDiv.html(resultString);
          resultDiv.removeClass("d-none");

        });


        probenListeEntries.set(char, forC);
        pl.append(forC);
      });
      probenListeInitialized = true;
    }

    var toption = $("#fertigkeitSelectorTalente").children("option:selected");

    if (toption.length === 0) return;
    var kategorie = toption.attr("data-kategorie");
    var f = toption.attr("data-fertigkeit");
    var t = toption.val().split(" [")[0];

    var dc = parseInt($("#fertigkeitSelectorModusText").val());


    if (isNaN(dc)) {
      $("#fertigkeitSelectorModusText").addClass("is-invalid");
      return;
    } else {
      $("#fertigkeitSelectorModusText").removeClass("is-invalid");
    }

    var sg = true;
    if ($("#fertigkeitSelectorModusVP").prop("checked")) {
      dc = dc + 10;
      sg = false;
    }

    var keepdc = dc;
    $.each(PhexCharacters, function(c, charname) {
      dc = keepdc;

      var char = PhexCharacterObjects(charname);
      var pw = getProbenWert(char, f);
      var pwPref = "PW ";

      $("#probenListAddon_" + charname.hashCode()).text($("#fertigkeitSelectorModusText").val() + " +");

      var mod = parseInt($("#probenListModifier_" + charname.hashCode()).val());
      if (isNaN(mod)) {
        $("#probenListModifier_" + charname.hashCode()).addClass("is-invalid");
        return;
      } else {
        $("#probenListModifier_" + charname.hashCode()).removeClass("is-invalid");
      }

      dc = dc + mod;





  //    var talentText = "";
      var talentClass = "badge-primary";
      if ($("#fertigkeitSelectorTalente").hasClass("usethis") && (char[kategorie+"Talente"][t].selected)) {
        pw = getProbenWertT(char,f);
        pwPref = "PW(T) "
  //      talentText = "hat Talent";
        talentClass = "badge-success";
      }
      if ($("#fertigkeitSelectorTalente").hasClass("usethis") && (!char[kategorie+"Talente"][t].selected)) {
  //      talentText = "hat Talent nicht";
        talentClass = "badge-danger";
      }


      var reqNr = Math.max(0, Math.ceil(dc-pw));
      if (reqNr > 20) {
        reqNr = -1;
      }
      var chance = 100;
      var chanceDyn = 100;

      for (var i = 0; i < reqNr-1; ++i) {
        chance = chance - probabilities[i];
      }
      if (!sg) {
        var dcalt = dc -10;
        var differenz = pw - dcalt;
        var scwahrscheinlichkeit = -1;
        if (differenz <= 20) {
          scwahrscheinlichkeit = 0;
          for (var sc = 0; sc < 20; ++sc) {
            scw = sc+differenz;
            nscwahrscheinlichkeit = 100;
            if (scw >= 0) {
              nscwahrscheinlichkeit = 0;
              for (var nsc = scw+1; nsc < 20; ++nsc) {
                nscwahrscheinlichkeit = nscwahrscheinlichkeit + probabilities[nsc];
              }
            }
            scwahrscheinlichkeit = scwahrscheinlichkeit + probabilities[sc]/100 * (100-nscwahrscheinlichkeit);
          }
          chanceDyn = scwahrscheinlichkeit;

        }
      }

      chance = chance.toFixed(2);
      $("#probenListeLiPW_" + charname.hashCode()).text(pwPref + pw);
      $("#probenListeLiPW_" + charname.hashCode()).removeClass("badge-danger");
      $("#probenListeLiPW_" + charname.hashCode()).removeClass("badge-success");
      $("#probenListeLiPW_" + charname.hashCode()).removeClass("badge-primary");
      $("#probenListeLiPW_" + charname.hashCode()).addClass(talentClass);


      if (reqNr >= 0) {
        $("#probenListeLiReq_" + charname.hashCode()).text("Benötigt (statisch): " + reqNr);
        $("#probenListeLiProb_" + charname.hashCode()).text("Erfolgswahrscheinlichkeit (statisch): " + chance + "%");
      } else {
        $("#probenListeLiReq_" + charname.hashCode()).text("Erfolg (statisch) nicht möglich.");
        $("#probenListeLiProb_" + charname.hashCode()).text("");
      }

      if (sg) {
        $("#probenListeLiProbDyn_" + charname.hashCode()).text("");
        $("#probenListeLiProbDyn_" + charname.hashCode()).addClass("d-none");
      } else {
        if (chanceDyn > 0) {
          chanceDyn = chanceDyn.toFixed(2);
          $("#probenListeLiProbDyn_" + charname.hashCode()).text("Erfolgswahrscheinlichkeit (dynamisch): " + chanceDyn + "%");
        } else {
          $("#probenListeLiProbDyn_" + charname.hashCode()).text("Erfolg (dynamisch) nicht möglich.");
        }
        $("#probenListeLiProbDyn_" + charname.hashCode()).removeClass("d-none");
      }

    });


  }



  function selectedPseudoForKategorie(kategorie) {
    var finder = getPseudoForKategorie(kategorie);
    if (finder.length == 0) return false;
    return finder.prop("selected");
  }
  function selectedPseudoForKategorieAndCharacter(kategorie, character) {
    var finder = getPseudoForKategorieAndCharacter(kategorie, character);
    if (finder.length == 0) return false;
    return finder.prop("selected");
  }

  function createPseudoForKategorie(kategorie) {
    var prefix = "";
    if ($("#fertigkeitSelectorDisplayFertigkeitenGrouped").prop("checked")) {
      prefix = kategorie + " ";
    }
    var text = prefix + "(Alle) " + kategorie + "-Talente";
    return $("<option id=\"fertigkeitSelectorFertigkeitenOption_" + kategorie + "_alle\">" + text + "</option>");
  }

  function createPseudoForKategorieAndCharacter(kategorie, character) {
    var prefix = "";
    if ($("#fertigkeitSelectorDisplayFertigkeitenGrouped").prop("checked")) {
      prefix = kategorie + " ";
    }
    var text = prefix + "(Alle) " + kategorie + "-Talente von " + character;
    return $("<option id=\"fertigkeitSelectorFertigkeitenOption_" + kategorie + "_alle_" + character + "\">" + text + "</option>");
  }


  function getPseudoForKategorie(kategorie) {
    return $("#fertigkeitSelectorFertigkeitenOption_" + kategorie + "_alle");
  }

  function getPseudoForKategorieAndCharacter(kategorie, character) {
    return $("#fertigkeitSelectorFertigkeitenOption_" + kategorie + "_alle_" + character);
  }

  function getAllPseudoForKategorieAndCharacter(kategorie) {
    return $("option[id^='fertigkeitSelectorFertigkeitenOption_" + kategorie + "_alle_']");
  }


  function updateFertigkeitSelector() {

    var diff = updateFertigkeitSelectorState();

    var fertigkeiten = $("#fertigkeitSelectorFertigkeiten");
    var talente = $("#fertigkeitSelectorTalente");

    var talentMustBeSelected = false;

    $.each(["K", "P", "U"],
    function(k, kategorie) {

      if (diff.added.kategorien.has(kategorie)) {
        var prefix = "";
        if ($("#fertigkeitSelectorDisplayFertigkeitenGrouped").prop("checked")) {
          prefix = kategorie + " ";
        }

        fertigkeiten.append(createPseudoForKategorie(kategorie));
        $.each(
          PhexCharacters, function(c, cc) {
            fertigkeiten.append(createPseudoForKategorieAndCharacter(kategorie, cc));
          }
        );

        $.each(
          Ilaris[kategorie + "Fertigkeiten"],
          function(f, ff) {
            fertigkeiten.append($("<option id=\"fertigkeitSelectorFertigkeitenOption_" + kategorie + "_" + f.hashCode() + "\">" + prefix + f +"</option>"));
          }
        );
      }

      if (diff.removed.kategorien.has(kategorie)) {
        getPseudoForKategorie(kategorie).remove();
        getAllPseudoForKategorieAndCharacter(kategorie).remove();
        $.each(
          Ilaris[kategorie + "Fertigkeiten"],
          function(f, ff) {
            $("#fertigkeitSelectorFertigkeitenOption_" + kategorie + "_" + f.hashCode()).remove();
          }
        );
      }




  }


  );

  for (var tt of diff.removed.talente.keys()) {
    var tts = tt.split("_");
    $("#fertigkeitSelectorTalenteOption_" + tts[1].hashCode() + "_" + tts[2].hashCode()).remove();
  }

  for (var tt of diff.added.talente.keys()) {
    var tts = tt.split("_");
    klammer = "";
    if (tts[0] === "U") {
      klammer = " ["+ tts[1]+  "]";
    }
    talente.append($("<option id=\"fertigkeitSelectorTalenteOption_" + tts[1].hashCode() + "_" + tts[2].hashCode() + "\" data-kategorie =\"" + tts[0] + "\" data-fertigkeit =\"" + tts[1] + "\">" + tts[2] + klammer + "</option>"));
  }



  sortSelect(fertigkeiten);
  sortSelect(talente);

  if ((fertigkeitSelectorState.kategorien.size > 0) && (fertigkeitSelectorState.fertigkeiten.size === 0) && !(fertigkeiten.val === "")) {
    updateFertigkeitSelector();
  }

  talentMustBeSelected = selectedPseudoForKategorie("K") || selectedPseudoForKategorie("P") || selectedPseudoForKategorie("U");
  $.each(["K", "P", "U"], function(k, kategorie) {

    $.each(PhexCharacters, function(c, cc) {
      talentMustBeSelected = talentMustBeSelected || selectedPseudoForKategorieAndCharacter(kategorie, cc);
    });

  });

  updateTalentCheckbox(talentMustBeSelected,talentMustBeSelected);


  }

  function updateTalentCheckbox(disabled, force = false) {
    var cb = $("#fertigkeitSelectorTalenteJa");
    cb.prop("checked",cb.prop("checked") || force);
    cb.prop("disabled", disabled);
    cb.change();
  }

  function selectAll(select) {
    select.children("option").prop("selected", true);
  }
  function selectNone(select) {
    select.children("option").prop("selected", false);
  }

  function sortSelect(select) {
    var items = select.children("option").get();
    items.sort(function(a,b){
      var keyA = $(a).text();
      var keyB = $(b).text();

      if (keyA < keyB) return -1;
      if (keyA > keyB) return 1;

      return 0;
    });
    $.each(items, function(i, li){
      select.append(li);
    });
  }


  String.prototype.hashCode = function() {
    var hash = 0, i, chr;
    if (this.length === 0) return hash;
    for (i = 0; i < this.length; i++) {
      chr   = this.charCodeAt(i);
      hash  = ((hash << 5) - hash) + chr;
      hash |= 0;
    }
    return hash;
  };

  SimpleIlarisProbe = function(pw, additionalDice = 0) {
    var _wuerfel = new Wuerfel(20, 4+additionalDice).roll(3+additionalDice).median(3+additionalDice, Math.max(0, additionalDice-1));
    var _rolls = _wuerfel.readL(3+additionalDice);
    var _ew = _wuerfel.read() + pw;
    this.result = function() {
      return {rolls: _rolls, ew: _ew};
    };
    this.reroll = function() {
      _wuerfel.roll(3+additionalDice).median(3+additionalDice, Math.max(0, additionalDice-1));
      _rolls = _wuerfel.readL(3+additionalDice);
      _ew = _wuerfel.read() + pw;
      return this;
    };
  }



  Wuerfel = function(sides, memory = 10) {

    var _that = this;
    var _history = new RingQueue(memory);
    var _sides = sides;

    this.median = function() {
      var length = this.size();
      if (arguments.length > 0) length = arguments[0];
      var offset = 0;
      if (arguments.length > 1) offset = arguments[1];
      _history.enqueue(_history.headL.apply(_history, arguments).sort(function(a,b){return a-b;})[Math.ceil((length-1)/2) + offset]);
      return this;
    }

    this.size = function() {
      return _history.size();
    }

    this.roll = function(n = 1) {
      for (var i = 0; i < n; ++i) {
        var r = _roll();
        _history.enqueue(r);
      }
      return this;
    };

    this.read = function() {return _history.dequeue()};

    this.readL = function() {
      return _history.dequeueL.apply(_history,arguments);
    }

    this.skip = function(n =1) {
      _history.dequeueL(n);
      return this;
    }

    var _roll = function() {
      return getRandomInt(1, _sides);
    };

    /**
    * Returns a random integer between min (inclusive) and max (inclusive)
    * Using Math.round() will give you a non-uniform distribution!
    https://stackoverflow.com/questions/1527803/generating-random-whole-numbers-in-javascript-in-a-specific-range
    */
    var getRandomInt = function(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }



  }

  RingQueue = function(capacity) {
    var _capacity = capacity;
    var _buffer = new Array(capacity);
    var _size = 0;
    var _in = 0;

    this.enqueue = function(x) {
      if (_size === _capacity) throw {msg: "RingQueue overflow", capacity: _capacity, size: _size, in: _in};
      _buffer[_in] = x;
      _in = (_in+1)%_capacity;
      _size = _size+1;
      return this;
    }

    this.head = function() {
      if (_size === 0) throw {msg: "RingQueue: Head on empty queue"};
      var _out = (_in - _size+_capacity) % _capacity;
      return _buffer[_out];
    }

    this.headL = function() {

      var n = _size;

      if (arguments.length > 0) {
        n = arguments[0];
      }

      if (n === 0) return new Array(0);

      if (_size < n) throw {msg: "RingQueue: Not enough items.", required: n, size: _size};


      var _out = (_in - _size+_capacity) % _capacity;


      var firstn = Math.min(_capacity - _out, n);

      var result = _buffer.slice(_out,_out+firstn);

      if (firstn === n) return result;

      return result.concat(_buffer.slice(0,n-firstn));

    }

    this.size = function() {
      return _size;
    }



    this.dequeue = function() {
      var result = this.head();
      _size = _size - 1;
      return result;
    }

    this.dequeueL = function() {
      var result = this.headL.apply(this,arguments);
      _size = _size - result.length;
      return result;
    }
  }


  </script>


  </body>
  </html>
