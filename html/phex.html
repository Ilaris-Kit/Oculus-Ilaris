<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Oculus Ilaris</title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700" crossorigin="anonymous">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,800" crossorigin="anonymous">
  <script src='../js/download.js' defer="defer"></script>
  <script src="../js/local.js" defer="defer"></script>
  <script src="../js/ilaris.js" defer="defer"></script>
  <script src="../js/character.js" defer="defer"></script>
  <script src="../js/ui.js" defer="defer"></script>
  <script src="../js/vorteile.js" defer="defer"></script>

  <link rel="stylesheet" href="../css/common.css">

  <style>



  #fertigkeitSelectorCol {

  }

  #fertigkeitSelectorForm > div.form-group {
    width: 100%;
  }
  #fertigkeitSelectorForm > div.form-group > select {
    resize:vertical;
  }

  #fertigkeitSelectorForm > div.form-group > select > option {
    font-family: "Open Sans Condensed";
    font-size: 140%;
  }

  #fertigkeitSelectorFertigkeitenDiv, #fertigkeitSelectorTalenteDiv {
    min-width: 30%;
  }

  #fertigkeitSelectorFertigkeiten > option::first-letter {
    color: lightgray;
  }


  </style>

</head>
<body>

  <div id="navWrapper">

  </div>

  <div class="container">
    <div class="row">
      <div class="col-12">
        <div>
          <form id="fertigkeitSelectorForm" class="d-flex" style="justify-content: space-between; flex-wrap: wrap;">


            <div class="form-group" id="fertigkeitSelectorKategorienDiv">

            <div class="input-group">
              <span class="input-group-addon clickable"><input id="fertigkeitSelectorKategorienOptionK" type="checkbox" style="margin-right: .5rem;" checked>K</span>
              <span class="input-group-addon clickable"><input id="fertigkeitSelectorKategorienOptionP" type="checkbox" style="margin-right: 10px">P</span>
              <span class="input-group-addon clickable"><input id="fertigkeitSelectorKategorienOptionU" type="checkbox" style="margin-right: 10px">U</span>
              <span id="fertigkeitSelectorDisplayFertigkeitenGroupedSpan" style="flex-grow: 1; text-align: right;" class="input-group-addon clickable"><input id="fertigkeitSelectorDisplayFertigkeitenGrouped" type="checkbox" style="margin-right: 10px">Gruppieren</span>

            </div>
          </div>
            <div class="form-group" id="fertigkeitSelectorFertigkeitenDiv">
            <select class="form-control custom-select" id="fertigkeitSelectorFertigkeiten" style="flex-grow: 100";>
            </select>
            </div>



        <!--  <div class="form-group" id="fertigkeitSelectorKategorienDiv">
              <label for="fertigkeitSelectorKategorienLabel"><a id="fertigkeitSelectorKategorienAll" href="#fertigkeitSelectorKategorienAll">A</a>/<a id="fertigkeitSelectorKategorienNone" href="#fertigkeitSelectorKategorienNone">K</a></label>
              <select multiple class="form-control" id="fertigkeitSelectorKategorien">
                <option id="fertigkeitSelectorKategorienOptionK">K</option>
                <option id="fertigkeitSelectorKategorienOptionP">P</option>
                <option id="fertigkeitSelectorKategorienOptionU">U</option>
              </select>

            </div>-->
            <div class="form-group" id="fertigkeitSelectorTalenteDiv">
              <select class="form-control custom-select" id="fertigkeitSelectorTalente">
            </div>

          </form>
        </div>
      </div>
        </div>
      </div>





  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script>
  $("#navWrapper").load("nav.html", function() {$("#phexLink").addClass("active"); $(".navbar-brand").text("Phex");});
  $(document).ready(function () {


    initializeIlaris(function() {
      updateFertigkeitSelector();

      var fertigkeiten = $("#fertigkeitSelectorFertigkeiten");
      var fertigkeitenWrapper = $("#fertigkeitSelectorFertigkeitenDiv");
      var talente = $("#fertigkeitSelectorTalente");


      fertigkeiten.on("change", updateFertigkeitSelector);
      talente.on("change", updateFertigkeitSelector);
      $("#fertigkeitSelectorKategorienOptionK, #fertigkeitSelectorKategorienOptionP, #fertigkeitSelectorKategorienOptionU").on("change", updateFertigkeitSelector);
      $("#fertigkeitSelectorDisplayFertigkeitenGrouped").on("change", rewriteEntries);
      $(".clickable").on("click", function(e) {
        if ($(e.target).is("input[type='checkbox']")) return;
        $.each($(this).children("input[type='checkbox']"), function(i, cb) {
          $(cb).prop("checked", !$(cb).prop("checked"));
          $(cb).change();
        });
        e.preventDefault();

      }
    );

    var wide = false;

    $(window).resize(function(e) {
      if ($(window).width() >= 768 && wide == false) {
        wide = true;
        var grp = $("#fertigkeitSelectorDisplayFertigkeitenGroupedSpan");
        fertigkeiten.insertBefore(grp);
        fertigkeitenWrapper.addClass("d-none");
        return;
      }
      if ($(window).width() < 768 && wide == true) {
        wide = false;
        fertigkeitenWrapper.removeClass("d-none");
        fertigkeitenWrapper.append(fertigkeiten);
      }

    });

    $(window).trigger("resize");



    /*  $(document).on('click', 'a[href^="#fertigkeitSelector"]', function (event) {
        var href = $(this).attr('href');

        if (href.startsWith("#fertigkeitSelector")) {
          if (href.endsWith("All")) {
            selectAll($(href.split("All")[0]));
            event.preventDefault();
            updateFertigkeitSelector();
            return;
          }
          if (href.endsWith("None")) {
            selectNone($(href.split("None")[0]));
            event.preventDefault();
            updateFertigkeitSelector();
            return;
          }
        }

      });*/
/*
      var pickedUp = false;
      var pageY = 0;
      $("#fertigkeitSelectorCol").mousedown(function(e) {
          pickedUp = true;
          pageY = e.pageY;

      }).mousemove(function(e) {
          if (pickedUp) {
            var h = $(this).height();
            $(this).height(h + (e.pageY - pageY));
            pageY = e.pageY;

          }
       }).mouseup(function() {
          pickedUp = false;
      });
      */

    });
  });

  fertigkeitSelectorState = {
    kategorien: new Set(),
    fertigkeiten: new Set(),
    talente: new Set()
  }

  function rewriteEntries() {
    var group = $("#fertigkeitSelectorDisplayFertigkeitenGrouped").prop("checked");
    var fertigkeiten = $("#fertigkeitSelectorFertigkeiten");
    $.each(
      fertigkeiten.children("option"),
      function (o, option) {
        var text = $(option).text();
        var kategorie = $(option).attr("id").split("-")[1];

        var splitted = text.split(kategorie + " ");

        if ((splitted[0] === "")) {
          splitted.splice(0,1);
          text = splitted.join("");
        }

        var prefix = "";

        if (group) {
           prefix = kategorie + " ";
        }

        $(option).text(prefix + text);
      }
    );
    sortSelect(fertigkeiten);
  }

  function updateFertigkeitSelectorState() {
    var fertigkeiten = $("#fertigkeitSelectorFertigkeiten");
    var talente = $("#fertigkeitSelectorTalente");

    var diff = {
      added: {
        kategorien: new Set(),
        fertigkeiten: new Set(),
        talente: new Set()
      },
      removed: {
        kategorien: new Set(),
        fertigkeiten: new Set(),
        talente: new Set()
      }
    };


    $.each(
      ["K", "P", "U"],
      function(k, kategorie) {
        var kategorieSelected = $("#fertigkeitSelectorKategorienOption" + kategorie).prop("checked");

        if (fertigkeitSelectorState.kategorien.has(kategorie)) {
          if (kategorieSelected) {
            $.each(
              Ilaris[kategorie + "Fertigkeiten"],
              function(f, ff) {
                var fertigkeitSelected = $("#fertigkeitSelectorFertigkeitenOption-" + kategorie + "-" + f.hashCode()).prop("selected");
                if (fertigkeitSelectorState.fertigkeiten.has(f)) {
                  if (fertigkeitSelected) {

                  } else {
                    diff.removed.fertigkeiten.add(f);
                    fertigkeitSelectorState.fertigkeiten.delete(f);
                  }
                } else {
                  if (fertigkeitSelected) {
                    diff.added.fertigkeiten.add(f);
                    fertigkeitSelectorState.fertigkeiten.add(f);
                  } else {

                  }
                }
              }
            );
          } else {
            diff.removed.kategorien.add(kategorie);
            fertigkeitSelectorState.kategorien.delete(kategorie);
            $.each(
              Ilaris[kategorie + "Fertigkeiten"],
              function(f, ff) {
                diff.removed.fertigkeiten.add(f);
                fertigkeitSelectorState.fertigkeiten.delete(f);
              }
            );
          }
        } else {
          if (kategorieSelected) {
            diff.added.kategorien.add(kategorie);
            fertigkeitSelectorState.kategorien.add(kategorie);
            $.each(
              Ilaris[kategorie + "Fertigkeiten"],
              function(f, ff) {
                var fertigkeitSelected = $("#fertigkeitSelectorFertigkeitenOption-" + kategorie + "-" + f.hashCode()).prop("selected");
                  if (fertigkeitSelected) {
                    diff.added.fertigkeiten.add(f);
                    fertigkeitSelectorState.fertigkeiten.add(f);
                  }
              }
            );

          } else {
          }

        }

      });




      return diff;



    }

    function updateFertigkeitSelector() {

      var diff = updateFertigkeitSelectorState();

      var fertigkeiten = $("#fertigkeitSelectorFertigkeiten");
      var talente = $("#fertigkeitSelectorTalente");

      $.each(["K", "P", "U"],
      function(k, kategorie) {

        if (diff.added.kategorien.has(kategorie)) {
          var prefix = "";
          if ($("#fertigkeitSelectorDisplayFertigkeitenGrouped").prop("checked")) {
            prefix = kategorie + " ";
          }
          $.each(
            Ilaris[kategorie + "Fertigkeiten"],
            function(f, ff) {
              fertigkeiten.append($("<option id=\"fertigkeitSelectorFertigkeitenOption-" + kategorie + "-" + f.hashCode() + "\">" + prefix + f +"</option>"));
            }
          );
        }

        if (diff.removed.kategorien.has(kategorie)) {
          $.each(
            Ilaris[kategorie + "Fertigkeiten"],
            function(f, ff) {
              $("#fertigkeitSelectorFertigkeitenOption-" + kategorie + "-" + f.hashCode()).remove();
            }
          );
        }


      $.each(Ilaris[kategorie + "Fertigkeiten"],
      function(f, ff) {
        if (diff.added.fertigkeiten.has(f)) {
          $.each(
            ff["talente"],
            function(t, tt) {
              talente.append($("<option id=\"fertigkeitSelectorTalenteOption-" + tt.hashCode() + "\">" + tt + "</option>"));
            }
          );
        }

        if (diff.removed.fertigkeiten.has(f)) {
          $.each(
            ff["talente"],
            function(t, tt) {
              $("#fertigkeitSelectorTalenteOption-" + tt.hashCode()).remove();
            }
          );
        }
      }
      );


    }
    );




    sortSelect(fertigkeiten);
    sortSelect(talente);

    if ((fertigkeitSelectorState.kategorien.size > 0) && (fertigkeitSelectorState.fertigkeiten.size === 0) && !(fertigkeiten.val === "")) {
      updateFertigkeitSelector();
    }


  }

  function selectAll(select) {
    select.children("option").prop("selected", true);
  }
  function selectNone(select) {
    select.children("option").prop("selected", false);
  }

  function sortSelect(select) {
    var items = select.children("option").get();
    items.sort(function(a,b){
      var keyA = $(a).text();
      var keyB = $(b).text();

      if (keyA < keyB) return -1;
      if (keyA > keyB) return 1;

      return 0;
    });
    $.each(items, function(i, li){
      select.append(li);
    });
  }


  String.prototype.hashCode = function() {
    var hash = 0, i, chr;
    if (this.length === 0) return hash;
    for (i = 0; i < this.length; i++) {
      chr   = this.charCodeAt(i);
      hash  = ((hash << 5) - hash) + chr;
      hash |= 0; // Convert to 32bit integer
    }
    return hash;
  };
  </script>


</body>
</html>
